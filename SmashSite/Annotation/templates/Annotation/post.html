{% extends "Annotation/header.html" %}

{% block content %}

<script type="text/javascript">
	//references the youtube api
	var tag = document.createElement('script');
	tag.id = 'yt-iframe';
	tag.src = 'https://www.youtube.com/iframe_api';
	var firstScriptTag = document.getElementsByTagName('script')[0];
	firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

	var player;
	function onYouTubeIframeAPIReady() {
	/**
	*Instantiates a new Youtube player when the API has loaded.
	*/
		player = new YT.Player('yt-player');
	}

	function logTime(event){
	/**
	*Sets the value of the post's time to the current time of the video.
	*/
		document.getElementById("id_time").value = Math.floor(player.getCurrentTime());
	}
  
	function skipTo(time, halfSpeed){
	/**
	*Skips video to time and sets playback speed.
	*@param {time} int: the target time
	*@param {halfSpeed} boolean: true for 0.5 playback speed, false for 1.0
	*/
		player.seekTo(time, true);
		if(halfSpeed)
			player.setPlaybackRate(0.5);
		else
			player.setPlaybackRate(1);
		player.pauseVideo();
	}
	
	function showDelete(){
	/**
	*Brings up yes or no text to confirm a user wants to delete their post.
	*/
		var yesNo = document.getElementsByClassName("confirm");
		var i;
		for(i = 0;i < yesNo.length; i++){
			yesNo[i].style.display = "inline";
		}
		document.getElementById("delBtn").style.display = "none";
	}
	
	function hideDelete(){
	/**
	*Hides yes or no text for deletion confirmation.
	*/
		var yesNo = document.getElementsByClassName("confirm");
		var i;
		for(i = 0;i < yesNo.length; i++){
			yesNo[i].style.display = "none";
		}
		document.getElementById("delBtn").style.display = "inline";
	}
</script>


<div class="col-md-12" style="width:100%;">
	<!--The youtube iframe-->
	<div class="col-md-8">
		<div id="ytplayer" class="embed-responsive embed-responsive-16by9">
			<iframe id="yt-player" src="https://www.youtube.com/embed/{{ target_vod.return_youtube_id }}?rel=0&enablejsapi=1" ></iframe>
		</div>
	</div>
	<div class="col-md-4">
		<!--Make a comment-->
		<div class="row">
			<div class="input-group">
				{% if user.is_authenticated %}
					<form action="{{ request.path }}" method="post" enctype="multipart/form-data">
						{% csrf_token %}
						<div class="form-group">
							<label for="comment">Comment</label>
							<textarea class="form-control" rows="8" cols="80" id="id_body" name="body"></textarea>
						</div>
						<div class="form-group">
								{{ form.captcha }}
							<div class="col-sm-2 col-sm-offset-6">
								<input type="submit" name="comment" class="btn btn-primary" onclick="logTime()" value="Post"></button>
							</div>
						</div>
						{{ form.time }}
						
					</form>
				{% endif %}
			</div>
		</div>
		<!--Comments, only display if there exists comments-->
		{% if target_posts %}
		{% for post in target_posts %}
			<div class="post-box">
				<div class="row">
					<div class="row">
						<p>
							<a name="up" class="btn btn-default btn-xs" href="Annotationvote{{target_vod.id}}/{{ post.id }}"><span class="glyphicon glyphicon-arrow-up" aria-hidden="true"></span></a>
							<a href="Profile{{ post.user.id }}">{{post.user.username}}</a> &nbsp;&nbsp; {{post.vote_count}} votes {{post.date|timesince}} ago
							<!--a delete button if the poster is the current user-->
							{% if user.is_authenticated %}
								{% if user.id == post.user.id %}
									<button type="button" class="btn btn-default btn-xs" id="delBtn" onClick="showDelete()">Delete</button>
									<a href="Annotationdelete{{target_vod.id}}/{{ post.id }}" class="confirm">yes</a> 
									<a href="#" class="confirm" onClick="hideDelete()">no</a>
								{% endif %}
							{% endif %}
						</p>
					</div>
					<div class="row">
						{{post.body|safe|linebreaks}}
					</div>
					<div class="row">
						<p>
							<a href="javascript:skipTo({{ post.time }})" class="time-control">{{ post.formatTime }}</a> | <a href="javascript:skipTo({{ post.time }}, true)" class="time-control">Half Speed</a>
						</p>
					</div>
				</div>
			</div>
		{% endfor %}
		{% endif %}
	</div>
</div>
{% endblock %}